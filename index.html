<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Certificate Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
</head>
<body>
    <div class="min-h-screen bg-gray-100">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">
                    Certificate Management System <span class="text-gray-500 text-sm" id="accountId">Loading...</span>
                </h1>
                <nav class="flex space-x-4">
                    <button onclick="showTab('master')" id="masterTab" class="px-3 py-2 rounded-md text-sm font-medium bg-indigo-600 text-white">
                        üìÑ Master Certificates
                    </button>
                    <button onclick="showTab('holders')" id="holdersTab" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        üë• Certificate Holders
                    </button>
                    <button onclick="showTab('generated')" id="generatedTab" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        üìã Generated Certificates
                    </button>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Master Certificates Tab -->
            <div id="masterContent" class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Master Certificates (Templates)</h2>
                

                <div id="templatesList">
                    <p class="text-gray-600">Loading templates...</p>
                </div>
            </div>

            <!-- Certificate Holders Tab -->
            <div id="holdersContent" class="bg-white shadow overflow-hidden sm:rounded-lg p-6" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Certificate Holders</h2>
                <p class="text-gray-600">This section will allow you to manage recipients of certificates. (Coming soon!)</p>
            </div>

            <!-- Generated Certificates Tab -->
            <div id="generatedContent" class="bg-white shadow overflow-hidden sm:rounded-lg p-6" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Generated Certificates</h2>
                <p class="text-gray-600">This section will display certificates generated from templates for specific holders. (Coming soon!)</p>
            </div>
        </main>
    </div>

    <script>
        // Get account ID from URL
        function getAccountId() {
            const path = window.location.pathname;
            const pathParts = path.split('/').filter(part => part);
            return pathParts[0] || '001000000000001';
        }

        // Initialize the app
        function initApp() {
            const accountId = getAccountId();
            document.getElementById('accountId').textContent = `(${accountId})`;
            loadTemplates();
        }

        // Show tab content
        function showTab(tab) {
            // Hide all content
            document.getElementById('masterContent').style.display = 'none';
            document.getElementById('holdersContent').style.display = 'none';
            document.getElementById('generatedContent').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('masterTab').className = 'px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50';
            document.getElementById('holdersTab').className = 'px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50';
            document.getElementById('generatedTab').className = 'px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50';
            
            // Show selected content and highlight tab
            document.getElementById(tab + 'Content').style.display = 'block';
            document.getElementById(tab + 'Tab').className = 'px-3 py-2 rounded-md text-sm font-medium bg-indigo-600 text-white';
        }

        // Load templates
        async function loadTemplates() {
            try {
                const accountId = getAccountId();
                const response = await fetch(`/api/account/${accountId}/templates`);
                const data = await response.json();
                
                const templatesList = document.getElementById('templatesList');
                if (data.success && data.templates.length > 0) {
                    templatesList.innerHTML = `
                        <ul class="divide-y divide-gray-200">
                            ${data.templates.map(template => `
                                <li class="py-4 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 text-gray-500 mr-3">üìÑ</div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">${template.template_name}</p>
                                            <p class="text-sm text-gray-500">
                                                ${template.file_size ? `${(template.file_size / 1024).toFixed(2)} KB` : 'N/A'} | 
                                                Created: ${new Date(template.created_at).toLocaleDateString()}
                                            </p>
                                        </div>
                                    </div>
                                    <button onclick="editTemplate('${template.id}')" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                                        ‚úèÔ∏è Edit
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    templatesList.innerHTML = '<p class="text-gray-600">No templates found.</p>';
                }
            } catch (error) {
                document.getElementById('templatesList').innerHTML = `<p class="text-red-600">Error loading templates: ${error.message}</p>`;
            }
        }


        // Edit template with Adobe PDF Editor
        function editTemplate(templateId) {
            // Hide all content
            document.getElementById('masterContent').style.display = 'none';
            document.getElementById('holdersContent').style.display = 'none';
            document.getElementById('generatedContent').style.display = 'none';
            
            // Show PDF editor
            showPDFEditor(templateId);
        }

        // Show PDF Editor with Adobe Embed
        function showPDFEditor(templateId) {
            const editorHTML = `
                <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">PDF Editor</h2>
                        <button onclick="closePDFEditor()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700">
                            ‚ùå Close Editor
                        </button>
                    </div>
                    
                    <div class="mb-4 p-3 bg-blue-50 rounded-md">
                        <p class="text-sm text-blue-800">
                            <strong>Native PDF Field Editing:</strong> Click on any field in the PDF to edit it. 
                            Values are automatically saved to the database when you click "Save".
                        </p>
                    </div>
                    
                    <div id="pdfEditorContainer" class="border border-gray-300 rounded-lg" style="height: 600px;">
                        <div id="adobe-dc-view" style="width: 100%; height: 100%;"></div>
                    </div>
                    
                    <div class="mt-4 flex space-x-3">
                        <button onclick="savePDFFields('${templateId}')" id="saveBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                            üíæ Save Fields
                        </button>
                        <button onclick="downloadPDF('${templateId}')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                            üì• Download PDF
                        </button>
                    </div>
                    
                    <div id="saveStatus" class="mt-3 text-sm"></div>
                </div>
            `;
            
            document.querySelector('main').innerHTML = editorHTML;
            
            // Initialize Adobe PDF Embed API
            initializeAdobePDF(templateId);
        }

        // Initialize Adobe PDF Embed API
        function initializeAdobePDF(templateId) {
            // For now, show a working PDF editor interface
            document.getElementById('adobe-dc-view').innerHTML = `
                <div class="h-full flex flex-col items-center justify-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">üìÑ</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">PDF Editor Ready</h3>
                        <p class="text-gray-600 mb-4">Template ID: ${templateId}</p>
                        <div class="space-y-2 text-sm text-gray-500">
                            <p>‚Ä¢ Click on form fields to edit them</p>
                            <p>‚Ä¢ Use the Save Fields button to save your changes</p>
                            <p>‚Ä¢ Data is automatically saved to the database</p>
                        </div>
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <p class="text-blue-800 text-sm">
                                <strong>Note:</strong> This is a demo interface. In production, 
                                the Adobe PDF Embed API would load the actual PDF here.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Simulate a PDF viewer for demo purposes
            window.currentPDFViewer = {
                getFormFields: async function() {
                    // Return sample form fields for demo
                    return {
                        'company_name': 'Sample Company',
                        'policy_number': 'POL-123456',
                        'effective_date': '01/01/2025',
                        'expiration_date': '12/31/2025',
                        'insured_name': 'John Doe',
                        'address': '123 Main St, City, State 12345'
                    };
                }
            };
        }

        // Save PDF field values to database
        async function savePDFFields(templateId) {
            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            saveStatus.innerHTML = '<span class="text-blue-600">Saving field values...</span>';

            try {
                // Get field values from Adobe PDF Embed API
                if (window.currentPDFViewer) {
                    const formFields = await window.currentPDFViewer.getFormFields();
                    
                    const response = await fetch('/api/pdf/save-fields', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            template_id: templateId,
                            account_id: getAccountId(),
                            field_values: formFields
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        saveStatus.innerHTML = '<span class="text-green-600">‚úÖ Field values saved successfully!</span>';
                    } else {
                        saveStatus.innerHTML = `<span class="text-red-600">‚ùå Save failed: ${result.error}</span>`;
                    }
                } else {
                    saveStatus.innerHTML = '<span class="text-red-600">‚ùå PDF viewer not available</span>';
                }
            } catch (error) {
                saveStatus.innerHTML = `<span class="text-red-600">‚ùå Save error: ${error.message}</span>`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Fields';
            }
        }

        // Download PDF
        async function downloadPDF(templateId) {
            try {
                const response = await fetch(`/api/pdf/render/${templateId}`);
                if (!response.ok) throw new Error('Failed to download PDF');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `template_${templateId}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert(`Download failed: ${error.message}`);
            }
        }

        // Close PDF Editor
        function closePDFEditor() {
            // Reset to master certificates view
            showTab('master');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
