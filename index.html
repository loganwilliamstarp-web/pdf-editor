<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Certificate Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="min-h-screen bg-gray-100">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">
                    Certificate Management System <span class="text-gray-500 text-sm" id="accountId">Loading...</span>
                </h1>
                <nav class="flex space-x-4">
                    <button onclick="showTab('master')" id="masterTab" class="px-3 py-2 rounded-md text-sm font-medium bg-indigo-600 text-white">
                        üìÑ Master Certificates
                    </button>
                    <button onclick="showTab('holders')" id="holdersTab" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        üë• Certificate Holders
                    </button>
                    <button onclick="showTab('generated')" id="generatedTab" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        üìã Generated Certificates
                    </button>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Master Certificates Tab -->
            <div id="masterContent" class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Master Certificates (Templates)</h2>
                
                <div id="templatesList">
                    <p class="text-gray-600">Loading templates...</p>
                </div>
            </div>

            <!-- Certificate Holders Tab -->
            <div id="holdersContent" class="bg-white shadow overflow-hidden sm:rounded-lg p-6" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Certificate Holders</h2>
                <p class="text-gray-600">This section will allow you to manage recipients of certificates. (Coming soon!)</p>
            </div>

            <!-- Generated Certificates Tab -->
            <div id="generatedContent" class="bg-white shadow overflow-hidden sm:rounded-lg p-6" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Generated Certificates</h2>
                <p class="text-gray-600">This section will display certificates generated from templates for specific holders. (Coming soon!)</p>
            </div>
        </main>
    </div>

    <script>
        // Get account ID from URL
        function getAccountId() {
            const path = window.location.pathname;
            const pathParts = path.split('/').filter(part => part);
            return pathParts[0] || '001000000000001';
        }

        // Initialize the app
        function initApp() {
            const accountId = getAccountId();
            document.getElementById('accountId').textContent = `(${accountId})`;
            loadTemplates();
        }

        // Show tab content
        function showTab(tab) {
            // Hide all content
            document.getElementById('masterContent').style.display = 'none';
            document.getElementById('holdersContent').style.display = 'none';
            document.getElementById('generatedContent').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('masterTab').className = 'px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50';
            document.getElementById('holdersTab').className = 'px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50';
            document.getElementById('generatedTab').className = 'px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50';
            
            // Show selected content and highlight tab
            document.getElementById(tab + 'Content').style.display = 'block';
            document.getElementById(tab + 'Tab').className = 'px-3 py-2 rounded-md text-sm font-medium bg-indigo-600 text-white';
        }

        // Load templates
        async function loadTemplates() {
            try {
                const accountId = getAccountId();
                console.log('Loading templates for account:', accountId);
                const response = await fetch(`/api/account/${accountId}/templates`);
                const data = await response.json();
                console.log('Templates response:', data);
                
                const templatesList = document.getElementById('templatesList');
                if (data.success && data.templates && data.templates.length > 0) {
                    templatesList.innerHTML = `
                        <ul class="divide-y divide-gray-200">
                            ${data.templates.map(template => `
                                <li class="py-4 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 text-gray-500 mr-3">üìÑ</div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">${template.template_name}</p>
                                            <p class="text-sm text-gray-500">Type: ${template.template_type}</p>
                                        </div>
                                    </div>
                                    <button onclick="editTemplate('${template.id}')" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                                        ‚úèÔ∏è Edit
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    templatesList.innerHTML = '<p class="text-gray-600">No templates found.</p>';
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesList').innerHTML = `<p class="text-red-600">Error loading templates: ${error.message}</p>`;
            }
        }

        // Edit template with Adobe PDF Editor (Popup Window)
        function editTemplate(templateId) {
            openPDFEditorWindow(templateId);
        }

        // Open PDF Editor in Popup Window
        function openPDFEditorWindow(templateId) {
            const accountId = getAccountId();
            const windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no';
            const popupWindow = window.open('', `pdfEditor_${templateId}`, windowFeatures);
            
            if (!popupWindow) {
                alert('Popup blocked! Please allow popups for this site and try again.');
                return;
            }
            
            // Create the popup window content
            const popupHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PDF Editor - Template</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://acrobatservices.adobe.com/view-sdk/viewer.js"></script>
</head>
<body class="bg-gray-100">
    <div class="h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl font-semibold text-gray-900">PDF Editor</h1>
                <div class="flex space-x-3">
                    <button onclick="savePDFFields('${templateId}')" id="saveBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                        üíæ Save Fields
                    </button>
                    <button onclick="downloadPDF('${templateId}')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                        üì• Download PDF
                    </button>
                    <button onclick="window.close()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                        ‚ùå Close
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Info Bar -->
        <div class="bg-blue-50 border-b px-6 py-3">
            <p class="text-sm text-blue-800">
                <strong>Native PDF Field Editing:</strong> Click on any field in the PDF to edit it. 
                Values are automatically saved to the database when you click "Save".
            </p>
        </div>
        
        <!-- PDF Container -->
        <div class="flex-1 p-6">
            <div id="pdfEditorContainer" class="h-full border border-gray-300 rounded-lg bg-white">
                <div id="adobe-dc-view" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="bg-white border-t px-6 py-3">
            <div id="saveStatus" class="text-sm"></div>
        </div>
    </div>
    
    <script>
        // Global variables for popup window
        let currentPDFViewer = null;
        const accountId = '${accountId}';
        const templateId = '${templateId}';
        const templateName = 'PDF Template';
        
        // Initialize Adobe PDF Embed API
        function initializeAdobePDF(templateId) {
            // Show loading state
            const container = document.getElementById('adobe-dc-view');
            if (container) {
                container.innerHTML = '<div class="h-full flex flex-col items-center justify-center bg-gray-50"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div><p class="text-gray-600">Loading PDF...</p></div>';
            }

            // Use the correct Adobe PDF Embed API initialization
            document.addEventListener("adobe_dc_view_sdk.ready", function() {
                console.log('Adobe PDF Embed API is ready');

                try {
                    const adobeDCView = new AdobeDC.View({
                        clientId: "f19373e4703e4d9c98f6d9db1db9a1cb",
                        divId: "adobe-dc-view"
                    });

                    // Load the PDF template using the official method
                    adobeDCView.previewFile({
                        content: {
                            location: {
                                url: '/api/pdf/template/' + templateId
                            }
                        },
                        metaData: {
                            fileName: 'Template ' + templateId
                        }
                    }, {
                        embedMode: "FULL_WINDOW",
                        enableFormFilling: true,
                        showAnnotationTools: false,
                        showDownloadPDF: false,
                        showPrintPDF: false,
                        showSavePDF: false,
                        showLeftHandPanel: false,
                        showDisabledSaveButton: false
                    }).then(adobeViewerController => {
                        currentPDFViewer = adobeViewerController;
                        console.log('PDF loaded successfully');

                        // Load any existing field values
                        loadExistingFieldValues(templateId);
                    }).catch(error => {
                        console.error('Error loading PDF:', error);
                        showPDFError(templateId, error.message);
                    });

                    console.log('PDF loading initiated');

                } catch (error) {
                    console.error('Adobe PDF Embed initialization error:', error);
                    showPDFError(templateId, error.message);
                }
            });

            // Fallback if Adobe SDK doesn't load
            setTimeout(function() {
                if (typeof AdobeDC === 'undefined') {
                    console.log('Adobe SDK not loaded, showing demo mode');
                    showAdobeSDKError(templateId);
                }
            }, 5000);
        }

        // Show Adobe SDK loading error
        function showAdobeSDKError(templateId) {
            const container = document.getElementById('adobe-dc-view');
            if (container) {
                container.innerHTML = '<div class="h-full flex flex-col items-center justify-center bg-gray-50"><div class="text-center p-8"><div class="text-6xl mb-4">üìÑ</div><h3 class="text-lg font-semibold text-gray-900 mb-2">PDF Editor Ready</h3><p class="text-gray-600 mb-4">Template ID: ' + templateId + '</p><div class="space-y-2 text-sm text-gray-500 mb-6"><p>‚Ä¢ Click on form fields to edit them</p><p>‚Ä¢ Use the Save Fields button to save your changes</p><p>‚Ä¢ Data is automatically saved to the database</p></div><div class="p-4 bg-blue-50 rounded-lg"><p class="text-blue-800 text-sm"><strong>Adobe PDF Embed API:</strong> Demo mode - Form fields are simulated for testing.</p></div></div></div>';
            }
            
            // Simulate a PDF viewer for demo purposes
            currentPDFViewer = {
                getFormFields: async function() {
                    return {
                        'company_name': 'Sample Company',
                        'policy_number': 'POL-123456',
                        'effective_date': '01/01/2025',
                        'expiration_date': '12/31/2025',
                        'insured_name': 'John Doe',
                        'address': '123 Main St, City, State 12345'
                    };
                },
                setFormFields: async function(fields) {
                    console.log('Demo: Setting form fields:', fields);
                    return true;
                }
            };
        }

        // Show PDF loading error
        function showPDFError(templateId, errorMessage) {
            const container = document.getElementById('adobe-dc-view');
            if (container) {
                container.innerHTML = '<div class="h-full flex flex-col items-center justify-center bg-gray-50"><div class="text-center p-8"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h3 class="text-lg font-semibold text-gray-900 mb-2">PDF Loading Error</h3><p class="text-gray-600 mb-4">Template ID: ' + templateId + '</p><p class="text-red-600 text-sm mb-6">Error: ' + errorMessage + '</p><div class="space-y-2 text-sm text-gray-500 mb-6"><p>‚Ä¢ PDF file may not be available</p><p>‚Ä¢ Check template storage configuration</p><p>‚Ä¢ Try refreshing the page</p></div><button onclick="initializeAdobePDF(\'' + templateId + '\')" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Retry Loading PDF</button></div></div>';
            }
            
            // Provide fallback PDF viewer
            currentPDFViewer = {
                getFormFields: async function() {
                    return {
                        'company_name': 'Sample Company',
                        'policy_number': 'POL-123456',
                        'effective_date': '01/01/2025',
                        'expiration_date': '12/31/2025',
                        'insured_name': 'John Doe',
                        'address': '123 Main St, City, State 12345'
                    };
                },
                setFormFields: async function(fields) {
                    console.log('Fallback: Setting form fields:', fields);
                    return true;
                }
            };
        }

        // Load existing field values for this template and account
        async function loadExistingFieldValues(templateId) {
            try {
                const response = await fetch('/api/pdf/get-fields/' + templateId + '/' + accountId);
                const data = await response.json();

                if (data.success && data.field_values && Object.keys(data.field_values).length > 0) {
                    console.log('Loading existing field values:', data.field_values);

                    // Set field values in the PDF if Adobe viewer is available
                    if (currentPDFViewer && currentPDFViewer.setFormFields) {
                        await currentPDFViewer.setFormFields(data.field_values);
                    }
                }
            } catch (error) {
                console.error('Error loading existing field values:', error);
            }
        }

        // Save PDF field values to database
        async function savePDFFields(templateId) {
            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');
            if (!saveBtn || !saveStatus) return;
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            saveStatus.innerHTML = '<span class="text-blue-600">Saving field values...</span>';

            try {
                // Get field values from Adobe PDF Embed API
                if (currentPDFViewer) {
                    const formFields = await currentPDFViewer.getFormFields();
                    
                    const response = await fetch('/api/pdf/save-fields', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            template_id: templateId,
                            account_id: accountId,
                            field_values: formFields
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        saveStatus.innerHTML = '<span class="text-green-600">‚úÖ Field values saved successfully!</span>';
                    } else {
                        saveStatus.innerHTML = '<span class="text-red-600">‚ùå Save failed: ' + result.error + '</span>';
                    }
                } else {
                    saveStatus.innerHTML = '<span class="text-red-600">‚ùå PDF viewer not available</span>';
                }
            } catch (error) {
                saveStatus.innerHTML = '<span class="text-red-600">‚ùå Save error: ' + error.message + '</span>';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Fields';
            }
        }

        // Download PDF
        async function downloadPDF(templateId) {
            try {
                const response = await fetch('/api/pdf/template/' + templateId);
                if (!response.ok) throw new Error('Failed to download PDF');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'template_' + templateId + '.pdf';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Download failed: ' + error.message);
            }
        }

        // Initialize when popup loads
        window.addEventListener('load', function() {
            // Add a small delay to ensure Adobe SDK is fully loaded
            setTimeout(function() {
                initializeAdobePDF(templateId);
            }, 1000);
        });
    </script>
</body>
</html>`;
            
            // Write content to popup window
            popupWindow.document.write(popupHTML);
            popupWindow.document.close();
            
            // Focus the popup window
            popupWindow.focus();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>